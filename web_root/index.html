<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EPRI Wi-SUN Diagnostics</title>
  <script src="d3.v4.min.js">
  </script>
  <script src="tablegraph.js">
  </script>
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body>
  <div id="main" class="grid-container">
    <header id="page-header" class=
    "grid-100 tablet-grid-100 mobile-grid-100" role="banner">
      <h1><img src="epri-logo.jpg" width="255" height="48" alt=
      "EPRI: Electric Power Research Institute"></h1>
    </header>
    <div class="grid-65 tablet-grid-65 mobile-grid-100">
      <div class="box grid-container grid-parent">
        <ul class="tab">
          <li>
            <a href="#" class="tablinks" onclick=
            "openTab(event, 'AddrInfo')">Address Info</a>
          </li>
          <li>
            <a href="#" class="tablinks" onclick=
            "openTab(event, 'ConnMap')">Connectivity Map</a>
          </li>
          <li>
            <a href="#" class="tablinks" onclick=
            "openTab(event, 'SerialPort')">Serial Reliability</a>
          </li>
          <li>
            <a href="#" class="tablinks active" onclick=
            "openTab(event, 'IEs')">IEs</a>
          </li>
        </ul>

        <div id="AddrInfo" class="tabcontent">
          <h2>Address Information</h2>
          <button onclick="addrinfoUpdate()">Update</button>
          <p>
            <table id="addrTable">
                <thead>
                  <th>Name</th><th>Count</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </p>
        </div>

        <div id="ConnMap" class="tabcontent">
          <h2>Connectivity Map</h2>
          <h3><img src="network.svg" width="538" height="418" alt="network graph"></h3>
        </div>

        <div id="IEs" class="tabcontent" style="display: block;">
          <h2>Information Element Counters</h2>
          <div class="floating-box">
            <table id="myIECounts">
              <thead>
                <tr>
                  <th>Name</th><th>Count</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
          <div class="floating-box">
            <p id="mpie">This graph shows the counts of each kind of Information Elements (IE) received.</p>
          </div>
        </div>

        <div id="SerialPort" class="tabcontent">
          <h3>Serial Port Reliability</h3>
          <div class="nofloat">
            <p id="fcie">Success ratio of serial port packet reception.</p>
            <p id="badness">Number of serial port packet receive failures</p>
          </div>
        </div>

        <!-- ================================================= -->
        <script>
          // This is the function that drives all dynamic data
          (function() {
              var badness=0;
              var goodness=0;
              var width = window.innerWidth
                  || document.documentElement.clientWidth
                  || document.body.clientWidth;

              var height = window.innerHeight
                  || document.documentElement.clientHeight
                  || document.body.clientHeight;

              var t1 = new AutoTable("#myIECounts", true);
              var g1 = new Linegraph("#mpie", width*0.6, 240, 30, 750, 14);
              var g2 = new Linegraph("#fcie", width*0.7, 240, 30, 750, 1);
              var g3 = new Linegraph("#badness", width*0.7, 240, 30, 750, 1);
              var fixed = ['buildid','state'];
              var diags = ['diag 02'];
              //'neighbors', 'diag 01', 'diag 02', 'diag 03', 'diag 04', 'diag 05', 'diag 06', 'diag 07', 'diag 08', 'diag 09'];

              var requests = [];
              for (var i=0, tot=diags.length; i < tot; i++) {
                  requests.push(d3.json('/tool?'+diags[i]));
              }
              var responses = [];
              var diag = function() {
                  for (var i=0, tot=requests.length; i < tot; i++) {
                      requests[i].get(function(error, data) {
                          if (typeof data === 'undefined') {
                              //++badness;
                          } else {
                              //++goodness;
                              //responses.push(data);
                          }
                          responses[i]=data;
                      });
                  }
                  if (typeof responses[1] === 'undefined') {
                      ++badness;
                  } else {
                      ++goodness;
                      g1.update(Object.values(responses[1].iecounters));
                      t1.update(Object.entries(responses[1].iecounters));
                    }
                    percentage=goodness/(badness+goodness);
                    g2.update([percentage]);
                    g3.update([badness]);
                };
                d3.interval(diag, 11000);
            })()
        </script> 
          <!-- ================================================= -->

          <script>
          var addrinfoTable = new AutoTable("#addrTable", false);
          function addrinfoUpdate(){
              d3.json('/tool?diag 01', function(error, data) {
                  if (error || typeof data === "undefined") {
                  } else {
                    var stuff=Object.entries(data.addrinfo);
                    addrinfoTable.update(stuff);
                  }
              });
              }
          </script>
        <script>

        function openTab(evt, tabName) {
          // Declare all variables
          var i, tabcontent, tablinks;

          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
          }

          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
          }

          // Show the current tab, and add an "active" class to the link that opened the tab
          document.getElementById(tabName).style.display = "block";
          evt.currentTarget.className += " active";
        }
        </script>
      </div>
    </div>
    <div id="faux-footer"></div>
  </div>
  <footer id="page-footer" class="grid-container" role=
  "contentinfo">
    <div class="grid-100 tablet-grid-100 mobile-grid-100">
      <address>
        EPRI 3420 Hillview Avenue, Palo Alto, California 94304
      </address>
      <div>
        Â© Electric Power Research Institute, Inc. 2015-2016 All
        rights reserved
      </div>
    </div>
  </footer>
</body>
</html>
